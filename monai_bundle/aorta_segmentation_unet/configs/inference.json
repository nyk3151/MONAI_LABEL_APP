{
  "imports": ["$import glob", "$import os"],
  "bundle_root": ".",
  "ckpt_dir": "$@bundle_root + '/models'",
  "output_dir": "$@bundle_root + '/eval'",
  "dataset_dir": "/tmp",
  "datalist": "$list(sorted(glob.glob(@dataset_dir + '/*.nii*')))",
  "device": "$torch.device('cuda:0' if torch.cuda.is_available() else 'cpu')",
  "network_def": {
    "_target_": "UNet",
    "spatial_dims": 3,
    "in_channels": 1,
    "out_channels": 24,
    "channels": [16, 32, 64, 128, 256],
    "strides": [2, 2, 2, 2],
    "num_res_units": 2
  },
  "network": "$@network_def.to(@device)",
  "preprocessing": {
    "_target_": "Compose",
    "transforms": [
      {
        "_target_": "LoadImaged",
        "keys": ["image"]
      },
      {
        "_target_": "EnsureChannelFirstd",
        "keys": ["image"]
      },
      {
        "_target_": "ScaleIntensityRanged",
        "keys": ["image"],
        "a_min": -175,
        "a_max": 250,
        "b_min": 0.0,
        "b_max": 1.0,
        "clip": true
      },
      {
        "_target_": "CropForegroundd",
        "keys": ["image"],
        "source_key": "image"
      },
      {
        "_target_": "Orientationd",
        "keys": ["image"],
        "axcodes": "RAS"
      },
      {
        "_target_": "Spacingd",
        "keys": ["image"],
        "pixdim": [1.5, 1.5, 2.0],
        "mode": "bilinear"
      },
      {
        "_target_": "EnsureTyped",
        "keys": ["image"]
      }
    ]
  },
  "dataset": {
    "_target_": "Dataset",
    "data": "$[{'image': i} for i in @datalist]",
    "transform": "@preprocessing"
  },
  "dataloader": {
    "_target_": "DataLoader",
    "dataset": "@dataset",
    "batch_size": 1,
    "shuffle": false,
    "num_workers": 4
  },
  "inferer": {
    "_target_": "SlidingWindowInferer",
    "roi_size": [96, 96, 96],
    "sw_batch_size": 4,
    "overlap": 0.5
  },
  "postprocessing": {
    "_target_": "Compose",
    "transforms": [
      {
        "_target_": "Activationsd",
        "keys": ["pred"],
        "softmax": true
      },
      {
        "_target_": "AsDiscreted",
        "keys": ["pred"],
        "argmax": true
      }
    ]
  },
  "handlers": [
    {
      "_target_": "CheckpointLoader",
      "load_path": "$@ckpt_dir + '/best_metric_model.pth'",
      "load_dict": { "model": "@network" }
    },
    {
      "_target_": "StatsHandler",
      "iteration_log": false
    }
  ],
  "evaluator": {
    "_target_": "SupervisedEvaluator",
    "device": "@device",
    "val_data_loader": "@dataloader",
    "network": "@network",
    "inferer": "@inferer",
    "postprocessing": "@postprocessing",
    "val_handlers": "@handlers",
    "amp": true
  },
  "initialize": ["$setattr(torch.backends.cudnn, 'benchmark', True)"],
  "run": ["$@evaluator.run()"]
}
